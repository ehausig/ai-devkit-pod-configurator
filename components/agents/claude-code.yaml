# components/agents/claude-code.yaml
id: CLAUDE_CODE
name: Claude Code (AI Assistant)
group: ai-agents
requires: nodejs-version
description: Anthropic's AI coding assistant for development
pre_build_script: claude-code-setup.sh
installation:
  dockerfile: |
    # Install Claude Code as devuser
    USER devuser
    ENV NPM_CONFIG_PREFIX=/home/devuser/.npm-global
    ENV PATH="/home/devuser/.npm-global/bin:${PATH}"
    
    # Install Claude Code
    RUN npm install -g @anthropic-ai/claude-code
    
    # Verify Claude Code installation
    RUN which claude || (echo "Claude Code installation failed" && exit 1)
    
    # Switch back to root for remaining setup
    USER root
  inject_files:
    - source: CLAUDE.md
      destination: /tmp/CLAUDE.md
      permissions: 644
    - source: settings.local.json.template
      destination: /tmp/settings.local.json.template
      permissions: 644
entrypoint_setup: |
  # Claude Code specific setup
  echo "Setting up Claude Code environment..."
  
  # Create .claude directory for global Claude configuration
  if command -v claude &> /dev/null 2>&1 || [ -f /tmp/CLAUDE.md ]; then
      mkdir -p /home/devuser/.claude
  fi
  
  # Create .claude directory in workspace for project-specific settings
  if command -v claude &> /dev/null 2>&1 || [ -f /tmp/settings.local.json.template ]; then
      mkdir -p /home/devuser/workspace/.claude
  fi
  
  # Copy settings.local.json from template if it exists
  echo "Checking for settings.local.json..."
  if [ -f /tmp/settings.local.json.template ]; then
      echo "Found /tmp/settings.local.json.template"
      if [ ! -f /home/devuser/workspace/.claude/settings.local.json ]; then
          echo "Copying settings.local.json to workspace/.claude folder..."
          cp /tmp/settings.local.json.template /home/devuser/workspace/.claude/settings.local.json
          echo "settings.local.json copied successfully to /home/devuser/workspace/.claude/"
      else
          echo "settings.local.json already exists in workspace/.claude folder"
      fi
  else
      echo "No /tmp/settings.local.json.template found in image"
  fi
  
  # Copy CLAUDE.md to .claude folder if it exists
  echo "Checking for CLAUDE.md..."
  if [ -f /tmp/CLAUDE.md ]; then
      echo "Found /tmp/CLAUDE.md"
      if [ ! -f /home/devuser/.claude/CLAUDE.md ]; then
          echo "Copying CLAUDE.md to .claude folder..."
          cp /tmp/CLAUDE.md /home/devuser/.claude/CLAUDE.md
          echo "CLAUDE.md copied successfully to /home/devuser/.claude/"
      else
          echo "CLAUDE.md already exists in .claude folder"
      fi
  else
      echo "No /tmp/CLAUDE.md found in image"
  fi
  
  # Ensure proper ownership
  chown -R devuser:devuser /home/devuser/.claude 2>/dev/null || true
  chown -R devuser:devuser /home/devuser/workspace/.claude 2>/dev/null || true
  
  # Verify installed components (only if expected)
  if command -v claude &> /dev/null 2>&1; then
      echo "Claude Code is available at: $(which claude)"
  fi
memory_content: |
  #### Claude Code (AI Assistant)
  
  **Getting Started**:
  - Start Claude Code: `claude`
  - Open with file: `claude myfile.py`
  - Show help: `claude --help`
  
  **Features**:
  - AI-powered code completion and generation
  - Multi-file context awareness
  - Natural language to code translation
  - Code explanation and debugging help
  - Refactoring suggestions
  
  **Configuration**:
  - Settings stored in `~/.claude/`
  - Project settings in `workspace/.claude/settings.local.json`
  - See `~/.claude/CLAUDE.md` for environment-specific guidelines
  
  **Best Practices**:
  - Provide clear context in your requests
  - Use descriptive file names
  - Keep related files in the same directory
  - Review generated code before executing
  
  **Tips**:
  - Claude Code understands your installed tools
  - Ask for help with any language/framework in your environment
  - Use for learning new technologies
  - Great for writing tests and documentation
