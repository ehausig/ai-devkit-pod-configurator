id: SBT
name: SBT (Scala build tool)
group: build-tools
requires: java-version
description: Simple Build Tool - Interactive build tool for Scala and Java
installation:
  dockerfile: |
    # Pass Nexus configuration to this build stage
    ARG USE_NEXUS_APT
    ARG NEXUS_APT_URL
    RUN export DEBIAN_FRONTEND=noninteractive && \
        apt-get update && \
        apt-get install -y apt-transport-https curl gnupg && \
        if [ -n "$USE_NEXUS_APT" ] && [ -n "$NEXUS_APT_URL" ]; then \
            echo "deb ${NEXUS_APT_URL}/repository/sbt-apt-proxy/ /" | tee /etc/apt/sources.list.d/sbt.list; \
        else \
            echo "deb https://repo.scala-sbt.org/scalasbt/debian all main" | tee /etc/apt/sources.list.d/sbt.list && \
            echo "deb https://repo.scala-sbt.org/scalasbt/debian /" | tee /etc/apt/sources.list.d/sbt_old.list; \
        fi && \
        curl -sL "https://keyserver.ubuntu.com/pks/lookup?op=get&search=0x2EE0EA64E40A89B84B2DF73499E82A75642AC823" | apt-key add && \
        apt-get update && \
        apt-get install -y sbt && \
        rm -rf /var/lib/apt/lists/*
  nexus_config: |
    if [ -n "$USE_NEXUS_APT" ] && [ -n "$NEXUS_APT_URL" ]; then \
        mkdir -p /etc/skel/.sbt && \
        echo "[repositories]" > /etc/skel/.sbt/repositories && \
        echo "local" >> /etc/skel/.sbt/repositories && \
        echo "nexus: ${NEXUS_APT_URL}/repository/maven-public/" >> /etc/skel/.sbt/repositories && \
        echo "" >> /etc/skel/.bashrc && \
        echo "# Coursier configuration for Nexus" >> /etc/skel/.bashrc && \
        echo "export COURSIER_REPOSITORIES=\"${NEXUS_APT_URL}/repository/maven-public/\"" >> /etc/skel/.bashrc && \
        echo "# Force SBT to use only configured repositories" >> /etc/skel/.bashrc && \
        echo "export SBT_OPTS=\"-Dsbt.override.build.repos=true\"" >> /etc/skel/.bashrc; \
    fi
  test_command: sbt --version
